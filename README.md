# OpenBlocks "Пользователи"

### Инициатива OpenBlocks

Инициатива OpenBlocks &mdash; это проект с открытым исходным кодом, целью которого
является предоставить открытые и масштабируемые решения уровня предприятия.

### Описание
Сервис "Пользователи" служит источником мастер-данных по пользователям предприятия.


В рамках OpenBlocks предполагается, что все сервисы, включая UI, используют общую
платформу аутентификации на основе **Keycloak**. Ввиду этого сервис "Пользователи"
работает с запросами, ожидая получить в них JWT-токен, который затем будет проверен
на корпоративном Keycloak-сервере.

Основной особенностью сервиса "Пользователи" является интеграция с **Keycloak**.
Каждый вновь добавляемый пользователь также регистрируется в Keycloak предприятия, а 
база данных сервиса "Пользователи" вообще не содержит паролей и прочей аутентифицирующей 
информации ни в каком виде.

### Основная конфигурация

Обратите внимание на следующие секции в конфигурации сервиса.

```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:8534/realms/infra/protocol/openid-connect/certs
          issuer-uri: http://localhost:8534/realms/infra
```

В этом блоке задаются URL вашего сервиса Keycloak, "jwk-set-uri" служит для
получения JWKS-ключей и для последующей валидации JWT-токена, с которым приходят
запросы в сервис "Пользователи".

```yaml
app:
  keycloak-service:
    client-id: 'admin-cli'
    client-secret: 'W5jwTHQWUBXYaAgMPTyHwOkwL4A2yB0S'
    host: http://localhost:8534
    urls:
      admin-token: /realms/infra/protocol/openid-connect/token
      create-user: /admin/realms/infra/users
```

Этот блок задаёт клиентский ID и секрет для взаимодействия с REST API вашего
корпоративного Keycloak-сервиса. "host" указывает на хост, на котором развёрнут
Keycloak-сервер, а секция "urls" позволяет регулировать эндпойнты, по которым
доступно получение администраторского токена и создания нового пользователя.

### Основные эндпойнты

#### Создание нового пользователя
POST /v1/users

Авторизация: JWT-токен.

Создаёт нового пользователя в БД сервиса "Пользователи", а также регистрирует
его в Keycloak вашей компании.
```json
{
    "userName": "test@example.com",
    "password": "password123",
    "lastName": "Lastname",
    "firstName": "Name",
    "patronymicName": "Patronymic",
    "birthDate": "1988-12-03"
}
```

---

#### Изменение пароля пользователя
PUT /v1/users/password

Авторизация: JWT-токен.

Меняет пароль пользователя, заданного через **username** в Keycloak.
```json
{
  "userName": "test@example.com",
  "password": "password456"
}
```

---

#### Получение пользователя по ID
GET /v1/users/{id}

Авторизация: JWT-токен.

Возвращает данные пользователя по его числовому идентификатору. Если пользователь не
найден в БД сервиса "Пользователи", возвращается статус 404.

---

#### Получение пользователя по username
GET /v1/users/user-name/{username}

Авторизация: JWT-токен.

Возвращает данные пользователя по его строковому логину (username). Если пользователь не
найден в БД сервиса "Пользователи", возвращается статус 404.


---

#### Поиск пользователя по запросу
GET /v1/users/search?searchText={query}

Авторизация: JWT-токен.

Возвращает пользователей по поисковому запросу. Поиск ведётся по ФИО. Если в запросе
представлено одно слово, то оно считается фамилией. Если в запросе много слов, то первое
слово всегда считается фамилией, а остальные слова могут находиться на любой другой позиции
в полном имени.

Поиск является регистронезависимым. Разрешается поиск по части ФИО, но при этом требуется указать начало слова. Так, по запросу
"кузнец" будет найден Кузнецов, но не будет найден Разкузнецов.




## Полезные ссылки
* [Документация по Keycloak](https://www.keycloak.org/documentation)
